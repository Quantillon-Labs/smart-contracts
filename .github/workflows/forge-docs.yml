name: Forge Docs

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Needed for actions/deploy-pages OIDC
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable

      - name: Build contracts (optional but recommended)
        run: |
          cd quantillon-protocol
          forge build --sizes

      - name: Install mdBook
        run: |
          curl -sSL https://github.com/rust-lang/mdBook/releases/download/v0.4.40/mdbook-v0.4.40-x86_64-unknown-linux-gnu.tar.gz | tar -xz
          sudo mv mdbook /usr/local/bin/

      - name: Generate docs with correct GitHub URLs
        env:
          RUST_MIN_STACK: 50331648
        run: |
          cd quantillon-protocol

          # SAVE custom markdown files BEFORE deleting docs
          echo "Saving custom markdown documentation files..."
          mkdir -p /tmp/custom-docs
          for f in API.md API-Reference.md Quick-Start.md Integration-Examples.md Security.md Architecture.md Deployment.md favicon.png favicon.ico; do
            if [ -f "docs/$f" ]; then
              cp "docs/$f" "/tmp/custom-docs/$f"
              echo "Saved $f"
            fi
          done

          rm -rf docs

          # Store the original remote URL
          ORIGINAL_REMOTE=$(git remote get-url origin)
          echo "Original remote URL: $ORIGINAL_REMOTE"

          # Temporarily change the remote URL to point to the subdirectory
          echo "Temporarily changing remote URL to point to quantillon-protocol subdirectory..."
          git remote set-url origin "https://github.com/Quantillon-Labs/smart-contracts/quantillon-protocol.git"

          # Generate documentation (markdown only, no build yet)
          echo "Generating documentation markdown..."

          if timeout 600 forge doc --out docs; then
              echo "Documentation markdown generated successfully"
          else
              echo "Documentation generation failed, creating fallback..."
              mkdir -p docs/src
              echo "# Quantillon Protocol" > docs/src/README.md
              echo "Documentation generation failed. Please check the contract complexity." >> docs/src/README.md
              echo "# Summary" > docs/src/SUMMARY.md
              echo "- [Home](README.md)" >> docs/src/SUMMARY.md
          fi

          # COPY custom markdown files into docs/src/ so mdBook builds them with navigation
          echo "Copying custom markdown files into docs/src/..."
          for f in API.md API-Reference.md Quick-Start.md Integration-Examples.md Security.md Architecture.md Deployment.md; do
            if [ -f "/tmp/custom-docs/$f" ]; then
              cp "/tmp/custom-docs/$f" "docs/src/$f"
              echo "Copied $f to docs/src/"
            fi
          done

          # UPDATE SUMMARY.md to include custom pages at the top (after Home)
          echo "Updating SUMMARY.md to include custom documentation pages..."
          if [ -f "docs/src/SUMMARY.md" ]; then
            # Create new SUMMARY.md with custom pages inserted after Home
            {
              echo "# Summary"
              echo "- [Home](README.md)"
              echo ""
              echo "# Documentation"
              echo "- [API Documentation](API.md)"
              echo "- [Technical Reference](API-Reference.md)"
              echo "- [Quick Start Guide](Quick-Start.md)"
              echo "- [Integration Examples](Integration-Examples.md)"
              echo "- [Architecture Overview](Architecture.md)"
              echo "- [Security Guide](Security.md)"
              echo "- [Deployment Guide](Deployment.md)"
              echo ""
              # Append the rest of SUMMARY.md (skip the first two lines: # Summary and - [Home])
              tail -n +3 docs/src/SUMMARY.md
            } > docs/src/SUMMARY.md.new
            mv docs/src/SUMMARY.md.new docs/src/SUMMARY.md
            echo "SUMMARY.md updated successfully"
          fi

          # Build the documentation with mdBook
          echo "Building documentation with mdBook..."
          mdbook build docs

          # Restore the original remote URL
          echo "Restoring original remote URL..."
          git remote set-url origin "$ORIGINAL_REMOTE"

          echo "Post-processing GitHub URLs in generated HTML files..."

          # Find all HTML files in the docs/book directory and fix GitHub URLs
          find docs/book -name "*.html" -type f | while read -r file; do
              # Create a temporary file
              temp_file=$(mktemp)

              # Replace incorrect GitHub URLs with correct ones
              sed 's|https://github.com/Quantillon-Labs/smart-contracts/quantillon-protocol/blob/[^"]*/src/|https://github.com/Quantillon-Labs/smart-contracts/blob/main/quantillon-protocol/src/|g' "$file" > "$temp_file"

              # Also fix URLs that don't have the commit hash
              sed 's|https://github.com/Quantillon-Labs/smart-contracts/quantillon-protocol/src/|https://github.com/Quantillon-Labs/smart-contracts/quantillon-protocol/src/|g' "$temp_file" > "$file"

              # Clean up temporary file
              rm "$temp_file"
          done

          echo "Documentation built successfully with correct GitHub links!"
          echo "Original remote URL restored: $(git remote get-url origin)"

          # Copy our custom favicon files to override the default forge icons
          echo "Copying custom favicon files..."
          if [ -f "/tmp/custom-docs/favicon.png" ]; then
              cp /tmp/custom-docs/favicon.png docs/book/favicon.png
              echo "Custom favicon.png copied successfully"
          else
              echo "Warning: favicon.png not found"
          fi

          if [ -f "/tmp/custom-docs/favicon.ico" ]; then
              cp /tmp/custom-docs/favicon.ico docs/book/favicon.ico
              echo "Custom favicon.ico copied successfully"
          else
              echo "Warning: favicon.ico not found"
          fi

          echo "== top of docs =="
          ls -la docs
          echo "== site root (docs/book) =="
          ls -la docs/book

          # Check if documentation was generated successfully
          if [ -d "docs/book" ] && [ "$(ls -A docs/book)" ]; then
              echo "✅ Documentation generated successfully!"
              echo "Documentation files:"
              find docs/book -name "*.html" | head -10
          else
              echo "❌ Documentation generation failed!"
              echo "Creating emergency fallback documentation..."
              mkdir -p docs/book
              echo '<!DOCTYPE html><html><head><title>Quantillon Protocol Documentation</title></head><body><h1>Quantillon Protocol</h1><p>Documentation generation failed due to stack overflow. Please check the contract complexity.</p></body></html>' > docs/book/index.html
              echo "Emergency fallback documentation created"
          fi
          

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Post-process HTML
        run: |
          cd quantillon-protocol
          npm install
          node tools/doc-postprocess.mjs ./docs/book

      # REQUIRED by GitHub Pages before uploading the artifact
      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: quantillon-protocol/docs/book

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - id: deployment
        uses: actions/deploy-pages@v4