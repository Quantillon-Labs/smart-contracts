# Quantillon Protocol - Development Makefile
# Integrates Foundry commands with Slither security analysis

.PHONY: help build test coverage slither clean validate-natspec docs gas-analysis analyze-warnings deploy-localhost deploy-sepolia deploy-base deploy-full deploy-verify deploy-uups

# Configuration variables
RESULTS_DIR ?= results
BUILD_OUTPUT := $(RESULTS_DIR)/build-output.log

# Default target
help:
	@echo "ğŸ”§ Quantillon Protocol Development Commands:"
	@echo ""
	@echo "ğŸ“¦ Build & Compile:"
	@echo "  make build      - Compile all contracts"
	@echo "  make clean      - Clean build artifacts"
	@echo "  RESULTS_DIR=custom make build - Use custom output directory"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  make test       - Run all tests"
	@echo "  make coverage   - Generate test coverage report"
	@echo ""
	@echo "ğŸ” Security:"
	@echo "  make slither    - Run Slither security analysis"
	@echo "  make mythril    - Run Mythril symbolic execution analysis"
	@echo "  make security   - Run comprehensive security checks"
	@echo ""
	@echo "â›½ Gas Analysis:"
	@echo "  make gas-analysis - Run comprehensive gas optimization analysis"
	@echo ""
	@echo "âš ï¸  Warning Analysis:"
	@echo "  make analyze-warnings - Analyze and isolate build warnings"
	@echo ""
	@echo "ğŸ“ Documentation:"
	@echo "  make docs            - Generate HTML documentation"
	@echo "  make validate-natspec - Validate NatSpec documentation coverage"
	@echo ""
	@echo "ğŸš€ Development:"
	@echo "  make all        - Build, test, and analyze security"
	@echo ""
	@echo "ğŸŒ Deployment:"
	@echo "  make deploy-localhost - Deploy to localhost"
	@echo "  make deploy-multisig  - Deploy with multisig configuration"
	@echo "  make init-multisig    - Initialize multisig deployment"
	@echo "  make verify-multisig  - Verify multisig deployment"
	@echo "  make deploy-sepolia   - Deploy to Sepolia testnet"
	@echo "  make deploy-base      - Deploy to Base mainnet"
	@echo "  make deploy-full      - Full UUPS deployment with verification"
	@echo "  make deploy-uups      - Deploy UUPS proxies only (localhost)"
	@echo "  make deploy-verify    - Verify deployed contracts"

# Build contracts
build:
	@echo "ğŸ”¨ Building contracts..."
	@mkdir -p $(RESULTS_DIR)
	forge build --force 2>&1 | tee $(BUILD_OUTPUT)

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	forge clean
	@echo "ğŸ§¹ Cleaning results directory..."
	@rm -rf $(RESULTS_DIR)

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	forge test

# Generate coverage report
coverage:
	@echo "ğŸ“Š Generating coverage report..."
	FOUNDRY_PROFILE=coverage forge coverage --report lcov
	@echo "ğŸ§¹ Cleaning up coverage file..."
	@rm -f lcov.info

# Run Slither security analysis
slither:
	@echo "ğŸ” Running Slither security analysis..."
	@cd "$(CURDIR)" && ./scripts/run-slither.sh

# Run Mythril symbolic execution analysis
mythril:
	@echo "ğŸ” Running Mythril symbolic execution analysis..."
	@cd "$(CURDIR)" && ./scripts/run-mythril.sh



# Run comprehensive security checks
security: build slither mythril
	@echo "ğŸ›¡ï¸  Security analysis complete!"

# Run comprehensive gas analysis
gas-analysis:
	@echo "â›½ Running comprehensive gas analysis..."
	@cd "$(CURDIR)" && ./scripts/analyze-gas.sh
	@echo "â›½ Gas analysis complete!"

# Analyze build warnings
analyze-warnings:
	@echo "âš ï¸  Analyzing build warnings..."
	@cd "$(CURDIR)" && ./scripts/analyze-warnings.sh
	@echo "âš ï¸  Warning analysis complete!"

# Run all checks
all: build test coverage slither docs gas-analysis analyze-warnings
	@echo "ğŸ¯ All checks completed successfully!"

# Install dependencies
install:
	@echo "ğŸ“¥ Installing dependencies..."
	forge install
	@echo "ğŸ“¦ Installing Slither dependencies..."
	python3 -m venv venv
	./venv/bin/pip install -r requirements.txt

# Generate HTML documentation
docs:
	@echo "ğŸ“š Generating HTML documentation..."
	@cd "$(CURDIR)" && ./scripts/build-docs.sh

# Validate NatSpec documentation
validate-natspec:
	@echo "ğŸ“ Validating NatSpec documentation..."
	@cd scripts && npm install --silent
	@cd scripts && node validate-natspec.js

# CI/CD pipeline command
ci: build test slither validate-natspec gas-analysis analyze-warnings
	@echo "ğŸš€ CI/CD pipeline completed!"

# Deployment targets
deploy-localhost:
	@echo "ğŸŒ Deploying to localhost..."
	@echo "âš ï¸  Make sure Anvil is running on localhost:8545"
	@export BASESCAN_API_KEY=dummy && forge script scripts/deployment/DeployQuantillon.s.sol --rpc-url http://localhost:8545 --broadcast
	@echo "âœ… Localhost deployment completed!"

deploy-multisig:
	@echo "ğŸŒ Deploying to localhost with multisig configuration..."
	@echo "âš ï¸  Make sure Anvil is running on localhost:8545"
	@export BASESCAN_API_KEY=dummy && forge script scripts/deployment/DeployMultisig.s.sol --rpc-url http://localhost:8545 --broadcast
	@echo "âœ… Multisig deployment completed!"

init-multisig:
	@echo "âš™ï¸ Initializing multisig deployment..."
	@echo "âš ï¸  Make sure contracts are deployed first"
	@forge script scripts/deployment/InitializeMultisig.s.sol --rpc-url http://localhost:8545 --broadcast
	@echo "âœ… Multisig initialization completed!"

verify-multisig:
	@echo "ğŸ” Verifying multisig deployment..."
	@forge script scripts/deployment/VerifyMultisig.s.sol --rpc-url http://localhost:8545
	@echo "âœ… Multisig verification completed!"

deploy-sepolia:
	@echo "ğŸŒ Deploying to Sepolia testnet..."
	@echo "âš ï¸  Make sure PRIVATE_KEY and network environment variables are set"
	@export NETWORK=sepolia && forge script scripts/deployment/DeployNetwork.s.sol --rpc-url $(SEPOLIA_RPC_URL) --broadcast --verify
	@echo "âœ… Sepolia deployment completed!"

deploy-base:
	@echo "ğŸŒ Deploying to Base mainnet..."
	@echo "âš ï¸  Make sure PRIVATE_KEY and network environment variables are set"
	@export NETWORK=base && forge script scripts/deployment/DeployNetwork.s.sol --rpc-url $(BASE_RPC_URL) --broadcast --verify
	@echo "âœ… Base deployment completed!"

deploy-full:
	@echo "ğŸŒ Full UUPS deployment with verification..."
	@export BASESCAN_API_KEY=dummy && forge script scripts/deployment/DeployUUPS.s.sol --rpc-url http://localhost:8545 --broadcast
	@echo "âœ… UUPS deployment completed!"
	@echo "ğŸ” Verifying deployment..."
	@forge script scripts/deployment/VerifyDeployment.s.sol --rpc-url http://localhost:8545
	@echo "âœ… Full deployment with verification completed!"

deploy-uups:
	@echo "ğŸŒ Deploying UUPS proxies to localhost..."
	@echo "âš ï¸  Make sure Anvil is running on localhost:8545"
	@export BASESCAN_API_KEY=dummy && forge script scripts/deployment/DeployUUPS.s.sol --rpc-url http://localhost:8545 --broadcast
	@echo "âœ… UUPS proxy deployment completed!"

deploy-verify:
	@echo "ğŸ” Verifying deployed contracts..."
	@forge script scripts/deployment/VerifyDeployment.s.sol --rpc-url http://localhost:8545
	@echo "âœ… Verification completed!"
